# Key management

Drafty notes from rgdd, nisse, and ln5 working together.  Might not make 100%
sense to others yet, a more detailed and polished version will appear soon.

What we discussed:

  - Signing key generation
  - Signing key backup
  - Signing key access ("signing oracle")

The assumed context here is: log server signing key.  But ~everything in this
document can also be applied for a witness signing key.

To keep the scope down, we're only considering use of YubiHSMs.

## Personnel and sites

For these notes we assume the following setting:

  - 3x trusted people with separate homes
  - 2x sites for backup
  - 2x sites for operation of a log server (primary and secondary)

The backup and log server operation sites may be (but doesn't have to be) the
same sites.  Some degree of physical security is assumed for these "sites".

The level of security for "homes" is that there's at least a safe available.

## Required equipment

  - 1x provisioning machine, not used for other things than key management
  - 4x YubiHSM2 (2 for backup, 2 for online signing oracle access)
  - 3x USB thumb drives, different vendors.  Ext4 file system, no enc.
  - 5x tamper-evident bags (and more for when they need to be opened...)
  - 1x self-hosted git repository with email notifications to the 3x people

### Long-term secrets that can't be rotated easily

  - Log server signing key

### Long-term secrets that can be rotated with some effort

  - Backup YubiHSM keywrap passphrase
  - Backup YubiHSM authkey passphrase (all capabilities enabled)
  - Online YubiHSM-1 authkey passphrase (just signing oracle)
  - Online YubiHSM-2 authkey passphrase (just signing oracle)

### Properties / overview

  - Log server signing key never leaves any YubiHSM unencrypted.
  - "Backup passphrases" are only typed into the provisioning laptop (exposing
    them by mistake to a different system = consider all passphrases leaked)
  - The difficulty of brute forcing any long-term secret: 128-bit security.  All
    randomness comes from a random number generated located in a YubiHSM.
  - The two signing oracle YubiHSMs ("Online") can't export the secret signing
    key.  To have signing oracle access, a passphrase is needed.  During active
    use this passphrase is stored on the running system, accessible as root.
  - The above passphrases are stored and replicated on the 3x USB thumb drives.
  - One USB thumb drive + one backup YubiHSM = can recover log signing key.
  - USB thumb drives and backup YubiHSMs are never stored at rest in the same
    location.
  - The trusted personnel can **alone at their own discretion** gain access to
    both a USB thumb drive and a backup YubiHSM to perform key recovery.  That a
    tamper-evident bag has been opened is detectable, however.  Similarly, if a
    any of our YubiHSMs are stolen that is also detectable due to $processes.

### Detailed description

The log server signing key is generated on a YubiHSM device that is plugged into
a provisioning machine.  The provisioning machine is only used for key
management, never connected to any network, and stored on backup-site 1.

The generated signing key can only be exported in encrypted form.  This requires
two pass phrases for (1) key wrapping, and (2) YubiHSM session establishment.
These two passphrases have 128-bit security each, are generated by the YubiHSM's
randomness source, and are redundantly stored on 3x USB thumb drives.

Two separate authkey passphrases are also generated for the "Online" YubiHSMs.
These two authkey passphrases are also stored on the 3x USB thumb drives.

The generated signing key is imported to a secondary YubiHSM.  The second
YubiHSM gets the same configuration so that it can also export with wrapping.

The generated signing key is also imported to a 3rd and 4th "Online" YubiHSM,
which is configured to not allow the signing key to be exported.  I.e., just a
signing oracle if the authkey passphrase is known.  We use a separate authkey
passphrase for each online YubiHSM.  If an online YubiHSM is in active use, the
authkey passphrase is stored on the local system and accessible with root privs.
This passphrase is transferred to the local machine manually when needed only.

Backup YubiHSMs are never stored at rest in the same physical location.  They
also must not be stored in the same location as the above pass phrases.  To
detect possible breaches, all devices are stored in tamper-detection bags.  The
serial numbers of each tamper evident bag is stored in a self-hosted git
repository.  Any updates to this repository must be synced out-of-band, e.g., as
the result of being notified by email that someone pushed new commits.

To restore the log server signing key, one YubiHSM device and one USB thumb
drive needs to be in the same place.  Plug them into the provisioning machine
only.  If it is detected that a USB thumb drive may have been breached ("the
tamper-evident bag has been opened"), all pass phrases must be changed.

If it is detected that one of the YubiHSM is lost or broken (can we distinguish
a broken device from theft of the working device + replacement with a
look-alike?), we must use the working device to provision a replacement, create
new passphrases, and locate and destroy all the copies of the old passphrases.

Concrete storage details for us:

  - Backup YubiHSM <serial>, site 1: office
  - Backup YubiHSM <serial>, site 2: xxx
  - USB thumbdrive <id>, person 1's home
  - USB thumbdrive <id>, person 2's home
  - USB thumbdrive <id>, person 3's home

Every 3 months we verify that the office backup YubiHSM works.  Every year, we
swap backup YubiHSM's between the two sites (to verify that the other one works
too).

The two "online" YubiHSMs are plugged into the two sites where the log server is
operated.  See above for how the needed authkey passphrases are made available.

(Note: we need the authkey passphrase available on the primary so that it is
possible to, e.g., reboot without an admin being around to insert a passphrase.)

(Note: why not replace the two backup YubiHSMs with USB thumb drives, i.e.,
could we not age encrypt the long-term signing key with our "keywrap" pass
phrase?  This may not be a bad idea, but it makes the tamper detection bags and
related processes more critical, since that's our only way to detect if an
attacker has made a copy of the contents on the drive. A stolen/replaced YubiHSM
is less subtle and easier to notice.  So using a YubiHSM is a defense-in-depth,
also helps with kgen etc.  Another reason to not USB stick: a YubiHSM may be
more likely to not get corrupted.)

## Misc

With one more YubiHSM, the same procedure can be used for our witness.

Linus will think about if [mandos][] would be worthwhile to eventually consider.

Rasmus will document this in more detail.

[mandos]:  https://www.recompile.se/mandos

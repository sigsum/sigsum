A proposal to adopt a signature format for tree heads that is defined in terms of the checkpoint format to increase interoperability with the Omniwitness ecosystem (and to potentially support key rotation).

## Background

The Go Checksum Database and a few other logs use [the checkpoint format](https://github.com/transparency-dev/formats/blob/main/log/README.md#checkpoint-format) for their signed tree heads. A checkpoint looks like this: one arbitrary line that specifies the log identity, log size, tree head, and zero or more arbitrary lines, followed by one or more signatures.

```
go.sum database tree
15368405
/g9am3I6YWNKaZX/jkne1fqd9zEyjss+JXyPXG0WfkY=
optional unspecified line, not actually in use
optional unspecified line, not actually in use

— sum.golang.org Az3grqJGUaSGukG9p8nI2vKgiFn7qGHxn0W+mrwyI6Gz3F0t1J3LzmWk/p96Ybf295EjwdSwlzgijq5WA9d1Ded7owM=
```

Conversely, Sigsum doesn’t currently specify a signed tree head encoding format, but conveys them as a sequence of `size`, `root_hash`, `signature`, and `cosignature` parameters, where `signature` signs `size` and `root_hash`, while `cosignature` also signs the log key hash and a timestamp.

Adopting a signing format based on the checkpoint encoding would allow Sigsum logs to be cosigned by witnesses in the Omniwitness ecosystem (and vice versa). Note that Sigsum logs don’t need to actually serialize data as checkpoints, because the format can be considered an encoding for the signed data.

Moreover, the checkpoint format natively allows [key rotation](https://git.glasklar.is/sigsum/project/documentation/-/issues/26) thanks to the identity line (if changes to log identity are adopted).

## Proposal

The serialization format of the messages signed by log and witness keys, currently `signed_tree_head` and `cosigned_tree_head` respectively, is replaced by a format defined based on to the [checkpoint specification](https://github.com/transparency-dev/formats/blob/main/log/README.md#checkpoint-format).

For log signatures, the proposed format matches the format currently in use by the Go Checksum Database exactly. Sigsum witnesses will accept tree heads from the Go Checksum Database (and compatible logs), and witnesses that support those logs will accept tree heads from Sigsum logs.

Witness signatures are different from those generated by Omniwitness witnesses: they include an extra prefix and timestamp, and don’t sign the extension lines, if present. We believe there is enough technical justification for these changes to encourage the Omniwitness ecosystem to adopt them.

The OpenSSH file signature format is abandoned. Keys are expected not to be used for multiple purposes, and versioning of witness semantics is handled with a simple ASCII prefix.

### Checkpoint fields

As the origin line, Sigsum logs would currently use `sigsum.org/v1/` followed by the lowercase hex encoding of the log key hash. This doesn’t lead to smooth key rotation, but this proposal focuses on incrementally adopting the new encoding format without changing semantics. A following proposal may introduce the concept of log identities separate from the log key.

The log size and tree head lines would have the same semantic meaning as both in current Sigsum and in the checkpoint format, as the two ecosystems both follow RFC 6962, and are encoded according to the checkpoint specification: ASCII decimal for the log size and Base64 for the tree head.

### Log signatures

Logs sign the whole note body directly with Ed25519.

The signature output is encoded directly as the `signature` field of `get-tree-head` API requests in the Sigsum ecosystem.

To produce signed notes compatible with the Omniwitness ecosystem, these signatures are encoded according to the [signed note specification](https://pkg.go.dev/golang.org/x/mod/sumdb/note) with the log’s origin line as the key Name, and the first 4 bytes of the key hash as the KeyHash. This is redundant, but it encodes the current 1:1 mapping of key to log identity of Sigsum logs into the more flexible checkpoint ecosystem.

#### Example

A log with key hash `a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd` signs a tree head with size 15368405 and hash `31JQUq8EyQx5lpqtKRqryJzA+77WD2xmTyuB4uIlXeE=`.

The Ed25519 key is used to produce a signature over the following message (including the final newline).

```
sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd
15368405
31JQUq8EyQx5lpqtKRqryJzA+77WD2xmTyuB4uIlXeE=
```

The signature is then used as-is for Sigsum APIs. To produce a signed checkpoint, it’s encoded as follows.

```
sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd
15368405
31JQUq8EyQx5lpqtKRqryJzA+77WD2xmTyuB4uIlXeE=

— sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd 5+z2z6ylAOChjVZMtCHXjq+7r8dFdMWiB6LbJXNksbGCvxcQE6ZbPcHFxFqwb7mfPflQMOjiPl2bvmXvKhQBzM4pq/I=
```

### Witness signatures

Witnesses sign a message composed of one line spelling `cosignature v1`, one line representing the current timestamp in seconds since the UNIX epoch, encoded as an ASCII decimal with no leading zeroes, followed by the first three lines of the note body (including the final newline).

Additional lines are excluded because current witnesses are not parsing them, and can make no statements about their validity or global visibility.

The signature output is encoded directly as the third field (and the signed timestamp as the second field) of `cosignature` parameters in the Sigsum ecosystem.

To produce signed notes compatible with the Omniwitness ecosystem, these signatures are encoded as a `timestamped_signature` and then according to the signed note specification, with the witness name as the key Name, and the first 4 bytes of the witness key hash as the KeyHash.

```
struct timestamped_signature {
	u64 timestamp;
	u8 signature[64];
}
```

#### Example

A witness named `witness.example.com/w1` with key hash `jWbPP4actZDz+uVvOT7qCd2Fdb8G4qcGc9jwh0w25iA=` signs the tree head from the previous example at UNIX time 1679315147.

The Ed25519 key is used to produce a signature over the following message (including the final newline).

```
cosignature v1
1679315147
sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd
15368405
31JQUq8EyQx5lpqtKRqryJzA+77WD2xmTyuB4uIlXeE=
```

The cosignature for Sigsum APIs looks like follows.

```
8d66cf3f869cb590f3fae56f393eea09dd8575bf06e2a70673d8f0874c36e620 1679315147 119307c1245a24d8880e87bd0d89ffcd772bb4f1dea25308e4e59712164207d765ac326c5f76f6a328a7d673d9aa17f99cda34c547be99b2140640487d9faa9c
```

To produce a signed checkpoint, it’s encoded as follows.

```
sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd
15368405
31JQUq8EyQx5lpqtKRqryJzA+77WD2xmTyuB4uIlXeE=

— sigsum.org/v1/a275973457e5a8292cc00174c848a94f8f95ad0be41b5c1d96811d212ef880cd 5+z2z6ylAOChjVZMtCHXjq+7r8dFdMWiB6LbJXNksbGCvxcQE6ZbPcHFxFqwb7mfPflQMOjiPl2bvmXvKhQBzM4pq/I=
— witness.example.com/w1 jWbPPwAAAABkGFDLEZMHwSRaJNiIDoe9DYn/zXcrtPHeolMI5OWXEhZCB9dlrDJsX3b2oyin1nPZ\nqhf5nNo0xUe+mbIUBkBIfZ+qnA==
```
